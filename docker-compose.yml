version: "3.3"
services:
  monkitect_graph_nginx:
    image: nginx:1.21.5
    container_name: monkitect_graph_nginx
    restart: always
    ports:
      - 4503:80
    privileged: true
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/sites-enabled/:/etc/nginx/sites-enabled/
      - ./nginx/resources/:/code/resources/
      - ./static:/code/static
      - ./media:/code/media
    depends_on:
      - monkitect_graph

  monkitect_graph:
    image: registry.cn-zhangjiakou.aliyuncs.com/baiyigali/monkitect_graph:<<IMAGE_TAG>>
    container_name: monkitect_graph
    environment:
      - DEBUG=0
      - DB_HOST=<<DB_HOST>>
      - DB_NAME=<<DB_NAME>>
      - DB_USER=<<DB_USER>>
      - DB_PASSWORD=<<DB_PASSWORD>>
      - REDIS_HOST=<<REDIS_HOST>>
      - REDIS_USER=<<REDIS_USER>>
      - REDIS_PASSWORD=<<REDIS_PASSWORD>>
      - image_search_base_url=http://122.9.150.223:4504
    volumes:
      - ./media:/code/media
      - ./static:/code/static
      - ./logs:/code/logs
    restart: always
    command: python manage.py runserver 0.0.0.0:80
    shm_size: 1gb